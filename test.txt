画像加工による異常検知モデル学習用データセットの圧縮手法の提案20T331増田嶺(最所研究室)はじめに機械学習は,外観検査における異常検知に活用されている そのモデルの学習はクラウドサービス上で行われることが多く,データセットサイズは巨大なため,ストレージコストが高くなる問題が挙げられる この解決には,機械学習における画像データが類似性のある画像集合であるため,データを圧縮する方法が有効である 以前より,複数の画像をまとめて圧縮符号化する手法は研究されており,近年では画像間距離に基づいて並び替えを行い,HEVCを用いて符号化する手法が提案されている[1] 本研究では,さらに画像加工を組合せることによって,異常検知精度の維持と高い圧縮率の両立を実現する手法を提案する 本稿では,提案した手法及びその圧縮効果,異常検知モデルの精度変化について述べる 提案手法2 1概要本研究では,画像データセットをHEVCによって符号化する前に,画像加工する 画像データセットに対して画像内オブジェクトの位置合わせや背景削除を行い,データ間の類似性を高め,それらを1つの動画ファイルに圧縮する これにより,学習時の精度を落とすことなく圧縮効率を向上させている また,テスト用データに対しても学習用データセットと同様の加工を施すことで,学習済モデルの精度維持を実現する なお本稿では,剛体かつ画像間の類似性が高いと考えられる,工業製品の画像データセットを対象とした,提案手法の適用とその評価について述べる 2 2基準画像への位置合わせデータセットにおける各画像(以下,対象画像)内に存在する単独のオブジェクトを,基準となる画像(以下,基準画像)内のオブジェクトに重なるよう,位置を移動させる処理を行う なお,オブジェクトの位置をデータセットの画像のいずれかに揃えればよいため,どれを基準画像として選んでも構わない まず,特徴点抽出アルゴリズムAKAZEを用い,対象画像内オブジェクトの特徴量を抽出する 次に,基準画像と対象画像の特徴量を比較し,基準画像に対する対象画像の回転,拡大縮小,並行移動量をアフィン行列として推定する 最後に,推定したアフィン行列を用いて対象画像を移動させる これを学習用データセット内の全ての画像に対して繰り返す画像の特徴量を抽出する際,PythonライブラリRembgを用いて一時的な背景削除を行い,余分な情報を排除する 2 3背景削除2 2節で得た一時的背景削除済の画像群から,単一のマスク画像を作成し,切り抜きを行う Rembgによる背景削除は,必要な領域も切り取ってしまう可能性があるため,そのまま利用しただけでは学習時の精度に影響を及ぼす恐れがある そこで,各画像の切り抜き領域を示すマスク画像の論理和を求め,すべてのオブジェクトが収まる最小領域を持ったマスク画像を作成する(図1) これを用いて,全ての画像に対しマスク処理を行うことで,オブジェクトに干渉しない範囲の背景を大まかに削除できる(図2) 2 4動画ファイルへの変換加工した画像データセットを,動画ファイルへと変換する 変換は,HEVCの非可逆圧縮モードを用い,画像1枚を動画データの1フレームとした上で圧縮する HEVCによる変換では,画像間の冗長性を排除して符号化されるため,画像データセットサイズの大幅な縮小が期待される 2 5学習とテストに向けた前処理モデルの学習時には,一度動画ファイルへと変換したデータセットを,再び個々の画像ファイルに復元する これにより,従来と同様の方法で学習処理を行える また,テスト用データも学習用データセットと同様,位置合わせや背景削除を行い,異常検知精度の維持を目指す これは,2 2節及び2 3節の工程により,学習済モデルは,背景や位置による精度の偏りが生まれると予想されるためである 位置合わせの基準画像や,背景削除に使用するマスク画像は,学習用データセットの処理時に得たものを用いる 評価3 1比較内容提案手法が,モデルの精度を落とすことなく,データサイズを縮小することを確認する また,位置合わせと背景削除それぞれの効果も確認する 表1に,本稿で比較する各手法を列挙する 以後,各手法を表1で付与した番号を用いて呼称する 0のサイズは,オリジナルのPNG画像320枚の合計サイズ,それ以外の手法のサイズは,変換した動画ファイルのサイズである 1は,0の各AUC値に近似するように,HEVCにおける圧縮パラメタを調整したものである このパラメタは,3,5,7にも用いている2,4,6,8は,各手法に変更は加えず圧縮パラメタのみを調整し,画質を引き下げる代わりに,使用した動画作成ツールで設定可能な最大圧縮率まで高めたものである 本稿では,画像データセットとして,MVTecAD[2][3]のscrewクラスを用いた 位置合わせをする際の基準画像は,データセットの先頭に位置するものを選択する 図1マスク画像の論理和図2背景削除した画像群表1処理手法毎のファイルサイズと圧縮率及び学習済モデルのROCAUC番号処理手法の説明サイズ[KB]圧縮率[%]imagelevelROCAUCpixellevelROCAUC事前処理無し124,0003956 60 8440 983動画圧縮のみ3,134100 00 8460 9821の動画化パラメタ変更11 80 6770 957位置合わせと動画圧縮の組合せ2,95694 30 9440 9913の動画化パラメタ変更9 10 6260 949背景削除と動画圧縮の組合せ3,448110 00 6460 9655の動画化パラメタ変更15 40 6180 950位置合わせと背景削除と動画圧縮の組合せ2,55181 90 9790 9937の動画化パラメタ変更6 50 9300 985また,異常検知モデルの学習にはPaDiMを使用する 実験は,Windows11上で行う 画像加工にはOpenCVを,画像データセットのHEVCによる動画化にはFFmpegをそれぞれ用いる 3 2圧縮率の比較比較対象の各手法で生成されるデータセットファイルのサイズ及び,1の手法を基準とする圧縮率を表1の“圧縮率”に示す 表1の“圧縮率”より,同一の圧縮パラメタにおいては,位置合わせと背景削除を組合せた(7,8)場合,最も高い圧縮率を得られたことがわかる 位置合わせのみ(3,4)では,圧縮率はわずかな向上に留まることがわかる また,背景削除のみでは,圧縮率の向上に寄与しないこともわかる 3 3学習精度の比較各手法のデータセットで学習したモデルの精度を検証し,従来の手法(0)と同等以上のAUC値であることを確認する 動画化したデータセットをPNG形式の画像データセットに復元し,オリジナルのデータセット(0)と同じ条件で学習を行うなお,PaDiMは正常品の画像のみから画像の特徴量の分布を使って判定するため,本評価では正常品のみの画像データセットを圧縮する 各手法で生成したデータセットで学習したモデルを用い,テスト用データで検証した場合のAUC値を表1の“imagelevelROCAUC”と“pixellevelROCAUC”列に示す 前者は画像単位での正誤,後者はピクセル単位での正誤を値として計算する 表1より,1,3,7,8は0と同等以上の精度であることがわかる HEVCの圧縮パラメタ変更により限界まで圧縮した手法では,2,4,6,8のうち8のみが0と同等以上の精度を維持できていることがわかる 考察3 3節及び3 2節より,提案手法(8)では,モデルの精度を落とすことなく,高い圧縮率を実現できていた 一方で,2,4,6は圧縮パラメタの変更により,ファイルサイズはかなり小さくなっているものの,表1のAUC値より,0を大幅に下回る精度となった また,従来研究に近い動画化のみの手法(1,2)では,2のように品質を下げると精度低下を招くことから,提案手法はより高い圧縮率を実現しているといえる 位置合わせのみで圧縮率が向上しない理由として,背景情報が残存することによって,画像全体でみた時の冗長性が変化しないことが考えられる オブジェクトの位置合わせを行ったとしても,背景の情報は画像毎に異なるため,画像間の差分が大きくなった可能性がある 背景削除のみで圧縮率が向上しない要因としては,オブジェクトの位置が様々であることが挙げられる オブジェクトの向きや位置,拡大率が画像間で大きく異なるため,HEVCによる符号化処理に影響したものと考えられる 位置合わせと背景削除の両工程を採用することが,高い圧縮率の実現及び学習済モデルの精度維持の両立には有効であるといえる また,位置合わせを行った場合,AUC値が向上することが表1より確認できる これは,同一の位置及び向きの学習データが増加することにより,学習済モデルが強化されたことに起因するものと考えられる このAUC値向上分を,圧縮パラメタ変更による圧縮率向上に転嫁することで,提案手法ではより高い圧縮率を実現できたといえる おわりに画像加工とHEVCを用いた動画化による学習用データセットの新しい圧縮手法を提案した今後の課題として,画像加工によるさらなる圧縮率の向上及び,適応範囲の拡大が挙げられる 適応範囲を拡大するために,複数クラスを含むデータセットの一括圧縮手法を検討する 謝辞本研究にあたり,株式会社STNetのご協力ならびに種々のご助言を賜りましたことを感謝いたします 参考文献[1]LinaShaetal ,“NovelImageSetCompressionAlgorithmUsingRate-DistortionOptimizedMultipleReferenceIm-ageSelection”,IEEEAccess,Vol 6,pp 6690–66913,(2018) [2]PaulBergmannetal ,“TheMVTecAnomalyDetectionDataset
”,InternationalJournalofComputerVision,Vol 129,pp 1038–1059,(2021) [3]PaulBergmannetal ,“MVTecAD—AComprehen-siveReal-WorldDatasetforUnsupervisedAnomalyDetec-tion”,IEEE/CVFConferenceonComputerVisionandPat-ternRecognition(CVPR),pp 9584–9592,(2019)